% !TEX TS-program = xelatex
% !TEX encoding = UTF-8 Unicode

% This is a simple template for a LaTeX document using the "article" class.
% See "book", "report", "letter" for other types of document.

\documentclass[11pt]{book} % use larger type; default would be 10pt

\usepackage{ctex}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}

\usepackage{upgreek}
\usepackage{xltxtra}

\usepackage{geometry}

\usepackage{paralist}



\usepackage[utf8]{inputenc} % set input encoding (not needed with XeLaTeX)

%%% Examples of Article customizations
% These packages are optional, depending whether you want the features they provide.
% See the LaTeX Companion or other references for full information.
\usepackage{makeidx}


%%% PAGE DIMENSIONS
\usepackage{geometry} % to change the page dimensions
\geometry{a4paper} % or letterpaper (US) or a5paper or....
% \geometry{margin=2in} % for example, change the margins to 2 inches all round
% \geometry{landscape} % set up the page for landscape
%   read geometry.pdf for detailed page layout information

\usepackage{graphicx} % support the \includegraphics command and options

% \usepackage[parfill]{parskip} % Activate to begin paragraphs with an empty line rather than an indent

%%% PACKAGES
\usepackage{booktabs} % for much better looking tables
\usepackage{array} % for better arrays (eg matrices) in maths
\usepackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\usepackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\usepackage{subfig} % make it possible to include more than one captioned figure/table in a single float
% These packages are all incorporated in the memoir class to one degree or another...
\usepackage[colorlinks=true,linkcolor=blue]{hyperref}

%%% HEADERS & FOOTERS
\usepackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}

\usepackage{longtable}

\usepackage{color}
\definecolor{pblue}{rgb}{0.13,0.13,1}
\definecolor{pgreen}{rgb}{0,0.5,0}
\definecolor{pred}{rgb}{0.9,0,0}
\definecolor{pgrey}{rgb}{0.46,0.45,0.48}



\usepackage{listings}
\lstset{% Global setting
    %language=XX,
    xleftmargin=2em,
    backgroundcolor=\color{white},
    basicstyle=\ttfamily,
    keywordstyle=\bfseries,
    commentstyle=\rmfamily\itshape,
    stringstyle=\color{pred}\ttfamily,
    flexiblecolumns,
    showspaces=false,
    showtabs=false,
    breaklines=true,
    showstringspaces=false,
    breakatwhitespace=true,
    tabsize=2,
    commentstyle=\color{pgreen}
    %numbers=left,
    %numberstyle=\footnotesize  
}


%%% SECTION TITLE APPEARANCE
\usepackage{sectsty}
\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
% (This matches ConTeXt defaults)

%%% ToC (table of contents) APPEARANCE
\usepackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\usepackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

\newcommand\mgape[1]{\gape{$\vcenter{\hbox{#1}}$}}


\setmainfont{Minion Pro}
%%% END Article customizations

%%% The "real" document content comes below...
\makeindex

\title{短信管理系统}
\author{张国玉~~zgy@bz-inc.com}
%\date{} % Activate to display a given date or no date (if empty),
         % otherwise the current date is printed 

\begin{document}
\maketitle
%\makeindex
\tableofcontents
\listoffigures
\listoftables
\printindex




\part{互联网短信网关接口协议}

\begin{center}
\textbf{\huge 中国移动通信互联网短信网关接口协议}\\ \bigskip \bigskip \bigskip {\Large （China Mobile Peer to Peer, CMPP）} \\ {\large（V2.0）} \bigskip \\ \bigskip 2002年4月\\ \vfill 中国移动通信集团公司
\end{center}

\chapter{前言}

本规范为中国移动通信集团公司企业规范，简称CMPP，现阶段版本是对1.2.1版修订后形成的，为2.0版。

本规范描述了中国移动短信业务中各网元（包括ISMG、GNS和SP）之间的相关消息的类型和定义。根据业务的发展，规范中的信令操作和参数将会做进一步的调整和增加。

本规范解释权属于中国移动通信集团公司。

本规范起草单位：中国移动通信集团公司研发中心。


\chapter{范围}

本规范规定了以下三方面的内容：

\begin{compactenum}
\item 信息资源站实体与互联网短信网关之间的接口协议；
\item 互联网短信网关之间的接口协议；
\item 互联网短信网关与汇接网关之间的接口协议。
\end{compactenum}


\chapter{缩略语}

\begin{longtable}{|m{50pt}|m{140pt}|m{200pt}|}

\multicolumn{3}{r}{}
\tabularnewline\hline
英文缩写 & 英文全称 & 说明
\endhead

\caption{缩略语}\\
\hline
英文缩写 & 英文全称 & 说明
\endfirsthead

\multicolumn{3}{r}{}
\endfoot

\endlastfoot

\hline
ISMG& Internet Short Message Gateway & 互联网短信网关\\
\hline
SMPP&Short Message Peer to Peer & 短消息点对点协议\\
\hline
CMPP&China Mobile Peer to Peer& 中国移动点对点协议\\
\hline
SMC&Short Message Center&短消息中心\\
\hline
GNS&Gateway Name Server& 网关名称服务器（汇接网关）\\
\hline
SP&Service Provider& 业务提供者，即信息资源站实体\\
\hline
SMC&Short Message Control&SP为收取包月业务费用而向网关发送的消息，网关收到后不送给用户仅产生相应的话单；\\
\hline
ISMG\_Id& &网关代码：0XYZ01～0XYZ99，其中XYZ为省会区号，位数不足时左补零，如北京编号为1的网关代码为001001，江西编号为1的网关代码为079101，依此类推。\\
\hline
SP\_Id& & SP的企业代码：网络中SP地址和身份的标识、地址翻译、计费、结算等均以企业代码为依据。企业代码以数字表示，共6位，从“9XY000”至“9XY999”，其中“XY”为各移动公司代码。\\
\hline
SP\_Code & & SP的服务代码：服务代码是在使用短信方式的点播类业务中，提供给用户点播的内容/应用服务提供商代码。服务代码以数字表示，全国业务服务代码长度统一为 4 位，即“1000”－“9999”；本地业务服务代码长度统一为5 位，即  “01000”－“09999”。\\
\hline
Service\_Id &  & SP的业务类型，数字、字母和符号的 组合，由SP自定，如图片传情可定为TPCQ，股票查询可定义为11。\\
\hline
\end{longtable}


\chapter{网络结构}


如图1所示，互联网短信网关（ISMG）是外部信息资源站实体（SP）与移动网内短信中心之间的中介实体，互联网短信网关一方面负责接收SP发送给移动用户的信息和提交给短信中心。另一方面，移动用户点播SP业务的信息将由短信中心通过互联网短信网关发给SP。

另外，为了减轻短信中心的信令负荷，互联网短信网关还应根据路由原则将SP提交的信息转发到相应的互联网短信网关。互联网短信网关通过向汇接网关（GNS）查询的方式获得网关间的转发路由信息。


\chapter{CMPP功能概述}

CMPP协议主要提供以下两类业务操作：

\begin{compactenum}
\item 短信发送（Short Message Mobile Originate，SM MO）

典型的业务操作举例如图2所示：

\begin{compactenum}[1)]
\item 手机发出数据请求（可能是订阅信息或图片点播等），被源ISMG接收；
\item 源ISMG对接收到的信息返回响应；
\item 源ISMG在本地查询不到要连接的SP，向GNS(汇接网关)发路由请求信息；
\item GNS将路由信息返回；
\item 源ISMG根据路由信息将请求前转给目的ISMG；
\item 目的ISMG对接收到的信息返回响应；
\item 目的ISMG将请求信息送SP
\item SP返回响应；
\end{compactenum}

在以上操作中，步骤3到步骤8均使用CMPP协议；

在随后的操作中，目的ISMG在接收到SP的响应后将产生MO状态报告发给源ISMG。


\item 短信接收（Short Message Mobile Terminated，SM MT）

典型的业务操作举例如图3所示：

\begin{compactenum}[1)]
\item SP发出数据请求（可能是短信通知或手机铃声等），被源ISMG接收；
\item 源ISMG对接收到的信息返回响应；
\item 源ISMG在本地数据库中找不到要目的手机号段所对应网关代码，向GNS（汇接网关）发路由请求信息；
\item 汇接网关将路由信息返回；
\item 源ISMG根据路由信息将请求前转给目的ISMG；
\item 目的ISMG对接收到的信息返回响应；
\item 目的ISMG将请求信息发送至SMC；
\item SMC向目的ISMG返回响应；
\end{compactenum}

在上述操作中，步骤1到步骤6均使用CMPP协议；

在随后的操作中，SMC将通过NO.7信令网向移动用户发送信息，移动用户收到后将返回状态报告（Delivery-Receipt）给短信中心，短信中心将按照MO操作的流程将状态报告返回给SP（如果SP要求返回状态报告）。

\end{compactenum}


\chapter{协议栈}

CMPP协议以TCP/IP作为底层通信承载，具体结构由图4所示：


\chapter{通信方式}

SP与ISMG之间、ISMG之间进行信息交互时，可以采用长连接方式，也可以采用短连接方式。

\begin{compactitem}
\item 所谓长连接，指在一个TCP连接上可以连续发送多个数据包，在TCP连接保持期间，如果没有数据包发送，需要双方发链路检测包以维持此连接。

\item 所谓短连接是指通信双方有数据交互时，就建立一个TCP连接，数据发送完成后，则断开此TCP连接，即每次TCP连接只完成一对CMPP消息的发送。

\end{compactitem}




\section{长连接}

通信双方以客户-服务器方式建立TCP连接，用于双方信息的相互提交。当信道上没有数据传输时，通信双方应每隔时间C发送链路检测包以维持此连接，当链路检测包发出超过时间T后未收到响应，应立即再发送链路检测包，再连续发送N-1次后仍未得到响应则断开此连接。

参数C、T、N原则上应可配置，现阶段建议取值为：C=3分钟，T=60秒，N=3。
    
网关与SP之间、网关之间的消息发送后等待T秒后未收到响应，应立即重发，再连续发送N-1次后仍未得到响应则停发。

现阶段建议取值为：T=60秒，N=3。
    
消息采用并发方式发送，加以滑动窗口流量控制，窗口大小参数W可配置，现阶段建议为16，即接收方在应答前一次收到的消息最多不超过16条。

长连接的操作流程举例如图5所示：
\section{短连接}

通信双方以客户-服务器方式建立TCP连接，应答与请求在同一个连接中完成。系统采用客户/服务器模式，操作以客户端驱动方式发起连接请求，完成一次操作后关闭此连接。

网关与SP之间、网关之间的消息发送后等待T秒后未收到响应，应立即重发，再连续发送N-1次后仍未得到响应则停发。

现阶段建议取值为：T=60秒，N=3。
    
短连接的操作流程举例如图6所示：



\section{本协议中涉及的端口号}

\begin{table}[htbp]
\centering
\caption{CMPP端口号}
\begin{tabular}{|l|l|}
\hline
端口号 & 应用\\
\hline
7890&长连接（SP与网关间）\\
\hline
7900 &短连接（SP与网关间或网关之间）\\
\hline
7930&长连接（网关之间）\\
\hline
9168&短连接（短信网关与汇接网关之间）\\
\hline
\end{tabular}
\end{table}


\section{交互过程中的应答方式}

在SP与ISMG之间、SMC与ISMG之间及ISMG之间的交互过程中均采用异步方式，即任一个网元在收到请求消息后应立即回送响应消息。举例如图7所示： 



\chapter{消息定义}

\section{基本数据类型}

\begin{table}[htbp]
\centering
\caption{基本数据类型}
\begin{tabular}{|m{80pt}|m{250pt}|}
\hline
Unsigned Integer&无符号整数\\
\hline
Integer&整数，可为正整数、负整数或零\\
\hline
Octet String&定长字符串，位数不足时，如果左补0则补ASCII表示的零，如果右补0则补二进制的零\\
\hline
\end{tabular}
\end{table}


\section{消息结构}

\begin{table}[htbp]
\centering
\caption{消息结构}
\begin{tabular}{|m{80pt}|m{250pt}|}
\hline
项目 &说明\\
\hline
Message Header& 消息头(所有消息公共包头)\\
\hline
Message Body& 消息体\\
\hline
\end{tabular}
\end{table}


\section{消息头格式（Message Header）}


\begin{table}[htbp]
\centering
\caption{消息头格式}
\begin{tabular}{|m{60pt}|m{40pt}|m{85pt}|m{120pt}|}
\hline
字段名 & 字节数& 类型& 描述\\
\hline
Total\_Length	& 4 & Unsigned  Integer& 消息总长度(含消息头及消息体)\\
\hline
Command\_Id & 4 & Unsigned Integer & 命令或响应类型 \\
\hline
Sequence\_Id& 4 & Unsigned Integer& 消息流水号,顺序累加,步长为1,循环使用（一对请求和应答消息的流水号必须相同）\\
\hline
\end{tabular}
\end{table}




\section{信息资源站实体(SP)与互联网短信网关(ISMG)间的消息定义}

SP与ISMG之间互为客户/服务器，但要求SP首先以客户的身份请求连接到ISMG，之后SP与ISMG之间方可进行数据传输。


\subsection{SP请求连接到ISMG（CMPP\_CONNECT）操作	}


CMPP\_CONNECT操作的目的是SP向ISMG注册作为一个合法SP身份，若注册成功后即建立了应用层的连接，此后SP可以通过此ISMG接收和发送短信。

ISMG以CMPP\_CONNECT\_RESP消息响应SP的请求。

\begin{longtable}{|m{40pt}|m{30pt}|m{80pt}|m{150pt}|}



\end{longtable}

\subsubsection{CMPP\_CONNECT消息定义（SP\textrightarrow ISMG）}





\subsubsection{CMPP\_CONNECT\_RESP消息定义（ISMG\textrightarrow SP）}


\subsection{SP或ISMG请求拆除连接（CMPP\_TERMINATE）操作}
\subsubsection{CMPP\_TERMINATE消息定义（SP\textrightarrow ISMG或ISMG\textrightarrow SP）}
\subsubsection{CMPP\_TERMINATE\_RESP消息定义（SP\textrightarrow ISMG或ISMG\textrightarrow SP）}
\subsection{SP向ISMG提交短信（CMPP\_SUBMIT）操作}
\subsubsection{CMPP\_SUBMIT消息定义（SP\textrightarrow ISMG）}
\subsubsection{CMPP\_SUBMIT\_RESP消息定义（ISMG\textrightarrow SP）}
\subsection{SP向ISMG查询发送短信状态（CMPP\_QUERY）操作}
\subsubsection{CMPP\_QUERY消息的定义（SP\textrightarrow ISMG）}
\subsubsection{CMPP\_QUERY\_RESP消息的定义（ISMG\textrightarrow SP）}
\subsection{ISMG向SP送交短信（CMPP\_DELIVER）操作}
\subsubsection{CMPP\_DELIVER消息定义（ISMG\textrightarrow SP）}
\subsubsection{CMPP\_DELIVER\_RESP消息定义（SP\textrightarrow ISMG）}
\subsection{SP向ISMG发起删除短信（CMPP\_CANCEL）操作}
\subsubsection{CMPP\_CANCEL消息定义（SP\textrightarrow ISMG）}
\subsubsection{CMPP\_CANCEL\_RESP消息定义（ISMG\textrightarrow SP）}
\subsection{链路检测（CMPP\_ACTIVE\_TEST）操作}
\subsubsection{CMPP\_ACTIVE\_TEST定义（SP\textrightarrow ISMG或ISMG\textrightarrow SP）}
\subsubsection{CMPP\_ACTIVE\_TEST\_RESP定义（SP\textrightarrow ISMG或ISMG\textrightarrow SP）}
\section{互联网短信网关(ISMG)之间的消息定义}
\subsection{源ISMG请求连接到目的ISMG（CMPP\_CONNECT）操作}
\subsection{源ISMG请求拆除到目的ISMG的连接（CMPP\_TERMINATE）操作}

\subsection{链路检测（CMPP\_ACTIVE\_TEST）操作}
\subsection{源ISMG向目的ISMG转发短信（CMPP\_FWD）操作}
\subsubsection{CMPP\_FWD定义（ISMG\textrightarrow ISMG）}
\subsubsection{CMPP\_FWD\_RESP定义（ISMG\textrightarrow ISMG）}
\section{互联网短信网关(ISMG)与汇接网关(GNS)之间的消息定义}
\subsection{ISMG请求连接到GNS或GNS请求连接到ISMG（CMPP\_CONNECT）操作}
\subsection{ISMG请求拆除到GNS的连接或GNS请求拆除到ISMG的连接（CMPP\_TERMINATE）操作}
\subsection{ISMG向汇接网关查询MT路由（CMPP\_MT\_ROUTE）操作}
\subsubsection{CMPP\_MT\_ROUTE消息定义（ISMG\textrightarrow GNS）}
\subsubsection{CMPP\_MT\_ROUTE\_RESP消息定义（GNS\textrightarrow ISMG）}
\subsection{ISMG向汇接网关查询MO路由（CMPP\_MO\_ROUTE）操作}
\subsubsection{CMPP\_MO\_ROUTE消息定义（ISMG\textrightarrow GNS）}
\subsubsection{CMPP\_MO\_ROUTE\_RESP消息定义（GNS\textrightarrow ISMG）}
\subsection{ISMG向汇接网关获取路由（CMPP\_GET\_ROUTE）操作}
\subsubsection{CMPP\_GET\_ ROUTE消息定义（ISMG\textrightarrow GNS）}
\subsubsection{CMPP\_GET\_ ROUTE\_RESP消息定义（GNS\textrightarrow ISMG）}
\subsection{ISMG向汇接网关更新MT路由（CMPP\_MT\_ROUTE\_UPDATE）操作}
\subsubsection{CMPP\_MT\_ROUTE\_UPDATE消息定义（ISMG\textrightarrow GNS）}
\subsubsection{CMPP\_MT\_ROUTE\_UPDATE\_RESP消息定义（GNS\textrightarrow ISMG）}
\subsection{ISMG向汇接网关更新MO路由（CMPP\_MO\_ROUTE\_UPDATE）操作}
\subsubsection{CMPP\_MO\_ROUTE\_UPDATE消息定义（ISMG\textrightarrow GNS）}
\subsubsection{CMPP\_MO\_ROUTE\_UPDATE\_RESP消息定义（GNS\textrightarrow ISMG）}
\subsection{汇接网关向ISMG更新MT路由（CMPP\_PUSH\_MT\_ROUTE\_UPDATE）操作}
\subsubsection{CMPP\_PUSH\_MT\_ROUTE\_UPDATE消息定义（GNS\textrightarrow ISMG）}
\subsubsection{CMPP\_PUSH\_MT\_ROUTE\_UPDATE\_RESP消息定义（ISMG\textrightarrow GNS）}
\subsection{汇接网关向ISMG更新MO路由（CMPP\_PUSH\_MO\_ROUTE\_UPDATE）操作}
\subsubsection{CMPP\_PUSH\_MO\_ROUTE\_UPDATE消息定义（GNS\textrightarrow ISMG）}
\subsubsection{CMPP\_PUSH\_MO\_ROUTE\_UPDATE\_RESP消息定义（ISMG\textrightarrow GNS）}
\section{系统定义}
\subsection{Command\_Id定义}
\section{MO状态报告的产生}
\section{修订历史}



\end{document}
